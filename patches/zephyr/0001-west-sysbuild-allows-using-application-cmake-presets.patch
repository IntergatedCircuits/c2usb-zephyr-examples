From 662ed0c8d056ab5ee16078f7e9e71a769521d041 Mon Sep 17 00:00:00 2001
From: Benedek Kupper <kupper.benedek@gmail.com>
Date: Wed, 27 Aug 2025 10:09:00 +0200
Subject: [PATCH] west sysbuild allows using application cmake presets

---
 scripts/west_commands/build.py | 27 +++++++++++++++++++++++++++
 share/sysbuild/.gitignore      |  1 +
 2 files changed, 28 insertions(+)
 create mode 100644 share/sysbuild/.gitignore

diff --git a/scripts/west_commands/build.py b/scripts/west_commands/build.py
index 1b7bf3b80a..89340a524c 100644
--- a/scripts/west_commands/build.py
+++ b/scripts/west_commands/build.py
@@ -624,6 +624,10 @@ class Build(Forceable):
         if user_args:
             cmake_opts.extend(shlex.split(user_args))
 
+        # sysbuild has its own cmake project directory, so we need to
+        # copy the application's CMakePresets.json file and replace the paths
+        sysbuild_presets = SYSBUILD_PROJ_DIR / 'CMakePresets.json'
+        source_presets = pathlib.Path(self.source_dir) / 'CMakePresets.json'
         config_sysbuild = config_getboolean('sysbuild', None)
 
         if config_sysbuild is None:
@@ -631,6 +635,20 @@ class Build(Forceable):
             config_sysbuild = True
 
         if self.args.sysbuild or (config_sysbuild and not self.args.no_sysbuild):
+            try:
+                if source_presets.exists():
+                    with open(source_presets, 'r') as f:
+                        content = f.read()
+                    content = (content
+                        .replace("${sourceDir}", self.source_dir)
+                        .replace("${sourceParentDir}", str(pathlib.Path(self.source_dir).parent))
+                        .replace("${sourceDirName}", str(pathlib.Path(self.source_dir).name))
+                    )
+                    with open(sysbuild_presets, 'w') as f:
+                        f.write(content)
+            except Exception as e:
+                self.wrn(f'Failed to adopt CMakePresets.json to sysbuild: {e}')
+
             cmake_opts.extend([f'-S{SYSBUILD_PROJ_DIR}',
                                f'-DAPP_DIR:PATH={self.source_dir}'])
         else:
@@ -650,6 +668,15 @@ class Build(Forceable):
             final_cmake_args.extend(cmake_opts)
         run_cmake(final_cmake_args, dry_run=self.args.dry_run)
 
+        # clean up the sysbuild CMakePresets.json file after each run
+        if sysbuild_presets.exists():
+            try:
+                sysbuild_presets.unlink()
+            except FileNotFoundError:
+                pass
+            except Exception as e:
+                self.wrn(f'Failed to remove sysbuild CMakePresets.json: {e}')
+
     def _run_pristine(self):
         self._banner(f'making build dir {self.build_dir} pristine')
         if not is_zephyr_build(self.build_dir):
diff --git a/share/sysbuild/.gitignore b/share/sysbuild/.gitignore
new file mode 100644
index 0000000000..71585613e9
--- /dev/null
+++ b/share/sysbuild/.gitignore
@@ -0,0 +1 @@
+CMakePresets.json
\ No newline at end of file
-- 
2.43.0

