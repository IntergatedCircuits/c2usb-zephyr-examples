From f590feca1568a99caf6741cf0f0326a82a2f9e3d Mon Sep 17 00:00:00 2001
From: Benedek Kupper <kupper.benedek@gmail.com>
Date: Sat, 6 Sep 2025 10:30:57 +0200
Subject: [PATCH] west sysbuild allows using application cmake presets

---
 scripts/west_commands/build.py | 29 +++++++++++++++++++++++++++++
 share/sysbuild/.gitignore      |  1 +
 2 files changed, 30 insertions(+)
 create mode 100644 share/sysbuild/.gitignore

diff --git a/scripts/west_commands/build.py b/scripts/west_commands/build.py
index 1b7bf3b80a..ae931c9d46 100644
--- a/scripts/west_commands/build.py
+++ b/scripts/west_commands/build.py
@@ -631,6 +631,35 @@ class Build(Forceable):
             config_sysbuild = True
 
         if self.args.sysbuild or (config_sysbuild and not self.args.no_sysbuild):
+            # sysbuild has its own cmake project directory, so we need to
+            # copy the application's CMakePresets.json file and replace the paths
+            sysbuild_presets_link = SYSBUILD_PROJ_DIR / 'CMakePresets.json'
+            build_presets = pathlib.Path(self.build_dir) / 'CMakePresets.json'
+            source_presets = pathlib.Path(self.source_dir) / 'CMakePresets.json'
+            try:
+                # Only copy if source exists and build doesn't, or source is newer
+                if source_presets.exists():
+                    copy_needed = (
+                        not build_presets.exists() or
+                        source_presets.stat().st_mtime > build_presets.stat().st_mtime
+                    )
+                    if copy_needed:
+                        with open(source_presets, 'r') as f:
+                            content = f.read()
+                        content = (content
+                            .replace("${sourceDir}", self.source_dir)
+                            .replace("${sourceParentDir}", str(pathlib.Path(self.source_dir).parent))
+                            .replace("${sourceDirName}", str(pathlib.Path(self.source_dir).name))
+                        )
+                        with open(build_presets, 'w') as f:
+                            f.write(content)
+                # Create symlink if needed
+                if sysbuild_presets_link.exists() or sysbuild_presets_link.is_symlink():
+                    sysbuild_presets_link.unlink()
+                sysbuild_presets_link.symlink_to(build_presets)
+            except Exception as e:
+                self.wrn(f'Failed to mirror CMakePresets.json to build dir and link: {e}')
+
             cmake_opts.extend([f'-S{SYSBUILD_PROJ_DIR}',
                                f'-DAPP_DIR:PATH={self.source_dir}'])
         else:
diff --git a/share/sysbuild/.gitignore b/share/sysbuild/.gitignore
new file mode 100644
index 0000000000..71585613e9
--- /dev/null
+++ b/share/sysbuild/.gitignore
@@ -0,0 +1 @@
+CMakePresets.json
\ No newline at end of file
-- 
2.43.0

